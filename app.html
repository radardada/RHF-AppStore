<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RHF AppStore - Detail Aplikasi</title>
  <link rel="stylesheet" href="./assets/style.css">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <span class="brand-title">RHF AppStore</span>
        <span class="brand-sub">Detail Aplikasi</span>
      </div>
      <div class="toolbar">
        <a href="index.html" class="btn">⬅ Kembali</a>
      </div>
    </div>
  </header>

  <!-- Container -->
  <main class="container">
    <div id="appDetail" class="app-card"></div>
    <div id="reviews" class="mt-16">
      <h3>Ulasan Pengguna</h3>
      <div id="reviewList"></div>
      <form id="reviewForm" class="mt-12">
        <input type="text" id="reviewer" class="input mb-8" placeholder="Nama Anda" required>
        <textarea id="reviewText" class="input mb-8" placeholder="Tulis ulasan..." required></textarea>
        <select id="reviewRating" class="select mb-8">
          <option value="5">⭐ 5</option>
          <option value="4">⭐ 4</option>
          <option value="3">⭐ 3</option>
          <option value="2">⭐ 2</option>
          <option value="1">⭐ 1</option>
        </select>
        <button type="submit" class="btn btn-primary">Kirim Ulasan</button>
      </form>
    </div>
  </main>

  <!-- Toast -->
  <div id="toast"></div>

  <!-- Firebase & Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAyHSaALeuwibcF22VNL_6WDlcZepcDB3A",
      authDomain: "rhf-gamestore.firebaseapp.com",
      databaseURL: "https://rhf-gamestore-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "rhf-gamestore",
      storageBucket: "rhf-gamestore.appspot.com",
      messagingSenderId: "52065906934",
      appId: "1:52065906934:web:c15f0eff91cc937f787cd7",
      measurementId: "G-RYFR9D5R5H"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Ambil ID aplikasi dari query string (?id=xxx)
    const params = new URLSearchParams(window.location.search);
    const appId = params.get("id");

    const appDetailEl = document.getElementById("appDetail");
    const reviewListEl = document.getElementById("reviewList");
    const reviewForm = document.getElementById("reviewForm");

    function toast(msg) {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.style.opacity = 1;
      setTimeout(() => (t.style.opacity = 0), 2500);
    }

    // Render detail aplikasi
    onValue(ref(db, "apps/" + appId), (snapshot) => {
      const appData = snapshot.val();
      if (!appData) {
        appDetailEl.innerHTML = "<p>Aplikasi tidak ditemukan.</p>";
        return;
      }
      appDetailEl.innerHTML = `
        <h2 class="app-title">${appData.name}</h2>
        <p class="app-meta">${appData.developer} — ${appData.category}</p>
        <p class="app-stats">⭐ ${appData.rating || 0} · ⬇️ ${appData.downloads || 0}</p>
        <div class="app-actions mt-12">
          <a class="btn btn-primary" href="${appData.apk_url}" download>Download APK</a>
        </div>
      `;
    });

    // Render ulasan
    onValue(ref(db, "reviews/" + appId), (snapshot) => {
      const reviews = snapshot.val() || {};
      reviewListEl.innerHTML = Object.values(reviews)
        .map(r => `
          <div class="app-card mb-8">
            <p><strong>${r.reviewer}</strong> — ⭐ ${r.rating}</p>
            <p>${r.text}</p>
          </div>
        `).join("");
    });

    // Tambah ulasan
    reviewForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const reviewer = document.getElementById("reviewer").value.trim();
      const text = document.getElementById("reviewText").value.trim();
      const rating = document.getElementById("reviewRating").value;

      if (!reviewer || !text) {
        toast("Isi semua field ulasan.");
        return;
      }

      const newReviewRef = push(ref(db, "reviews/" + appId));
      await set(newReviewRef, {
        reviewer,
        text,
        rating,
        created_at: Date.now()
      });

      reviewForm.reset();
      toast("Ulasan berhasil ditambahkan.");
    });
  </script>
</body>
</html>
